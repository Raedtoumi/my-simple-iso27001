name: ðŸ›¡ï¸ ISO 27001 Compliance Check - DEBUG

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      test-mode:
        description: 'Run in test mode'
        required: false
        default: true
        type: boolean

jobs:
  compliance-check:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get all history

      - name: ðŸ·ï¸ Show Git Info
        run: |
          echo "ðŸ” Repository: $GITHUB_REPOSITORY"
          echo "ðŸ” Branch: $GITHUB_REF"
          echo "ðŸ” Commit: $GITHUB_SHA"
          echo "ðŸ” Triggered by: $GITHUB_ACTOR"
          echo "ðŸ“ Current files:"
          ls -la

      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ðŸ” Debug Python Environment
        run: |
          echo "ðŸ Python version:"
          python --version
          echo "ðŸ“¦ Pip version:"
          pip --version
          echo "ðŸ“ Scripts directory:"
          ls -la scripts/

      - name: ðŸ“¦ Install Dependencies
        run: |
          echo "ðŸ“¦ Checking requirements.txt..."
          cat requirements.txt
          echo "ðŸš€ Installing dependencies..."
          pip install -r requirements.txt
          echo "âœ… Installed packages:"
          pip list

      - name: ðŸ§ª Run Tests Step by Step
        run: |
          echo "=== ðŸ§ª STEP 1: Check Scripts ==="
          python scripts/collect_evidence.py --help 2>/dev/null || echo "No --help option, but script exists"
          
          echo "=== ðŸ§ª STEP 2: Run Evidence Collection ==="
          python scripts/collect_evidence.py
          
          echo "=== ðŸ§ª STEP 3: Verify Evidence ==="
          if [ -f evidence/compliance_evidence.json ]; then
            echo "âœ… Evidence file created successfully!"
            echo "ðŸ“„ Evidence content preview:"
            head -20 evidence/compliance_evidence.json
          else
            echo "âŒ Evidence file missing!"
          fi

      - name: ðŸ“Š Generate Reports
        run: |
          echo "=== ðŸ“Š Generating Reports ==="
          python scripts/generate_report.py
          
          echo "ðŸ“ Reports directory contents:"
          ls -la reports/
          
          if [ -f reports/compliance_summary.md ]; then
            echo "âœ… Markdown report created!"
            echo "ðŸ“‹ Report preview:"
            head -10 reports/compliance_summary.md
          fi

      - name: ðŸŽ¯ Final Validation
        run: |
          echo "=== âœ… FINAL VALIDATION ==="
          echo "ðŸ“Š Compliance Score: $(jq -r '.compliance_score' reports/compliance_report.json 2>/dev/null || echo 'Unknown')%"
          echo "ðŸ“ˆ Checks Passed: $(jq -r '.summary.passed' reports/compliance_report.json 2>/dev/null || echo 'Unknown')"
          echo "ðŸŽ‰ Workflow execution: SUCCESS"

      - name: ðŸ“¤ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debug-reports-${{ github.run_id }}
          path: |
            evidence/
            reports/
          retention-days: 30